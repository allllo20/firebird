name: iOS (unsigned IPA)

on:
  workflow_dispatch:
    inputs:
      jit:
        description: "Build with TRANSLATION_ENABLED (JIT/translation) workaround not applied automatically"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  ios-unsigned-ipa:
    runs-on: macos-14

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # Qt installieren (Host + iOS target)
      - name: Install Qt (macOS + iOS)
        uses: jurplel/install-qt-action@v4
        with:
          version: "5.15.2"
          host: "mac"
          target: "ios"
          arch: "clang_64"
          cache: true

      - name: Build Xcode project via qmake
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build-ios
          cd build-ios

          JIT_INPUT="${{ inputs.jit || 'false' }}"
          if [[ "$JIT_INPUT" == "true" ]]; then
            echo "NOTE: JIT enabled. Repo README mentions qmake/xcodeproj quirk with asmcode_arm.S. This workflow does NOT auto-patch that."
            QMAKE_DEFS="TRANSLATION_ENABLED=true"
          else
            QMAKE_DEFS="TRANSLATION_ENABLED=false"
          fi

          # Generate Xcode project
          qmake ../firebird.pro -spec macx-ios-clang CONFIG+=release CONFIG+=xcode "$QMAKE_DEFS"

          # Detect project + scheme robustly
          PROJ="$(ls -1 *.xcodeproj | head -n 1)"
          echo "Using project: $PROJ"

          xcodebuild -list -project "$PROJ"

          SCHEME="$(xcodebuild -list -project "$PROJ" | awk '/Schemes:/{f=1;next} f&&NF{print $1; exit}')"
          if [[ -z "${SCHEME:-}" ]]; then
            echo "Could not detect scheme"; exit 1
          fi
          echo "Using scheme: $SCHEME"

          # Build for device WITHOUT signing
          xcodebuild \
            -project "$PROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            build

      - name: Package unsigned .ipa
        shell: bash
        run: |
          set -euo pipefail
          cd build-ios

          APP_PATH="$(find . -type d -name "*.app" -path "*Release-iphoneos*" | head -n 1)"
          if [[ -z "${APP_PATH:-}" ]]; then
            echo "No .app found (expected under *Release-iphoneos*)"; exit 1
          fi
          echo "Found app: $APP_PATH"

          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          IPA_NAME="Firebird-unsigned-${GITHUB_REF_NAME:-manual}.ipa"
          /usr/bin/zip -r "$IPA_NAME" Payload >/dev/null

          echo "IPA_PATH=$(pwd)/$IPA_NAME" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ${{ env.IPA_PATH }}

      # Optional: attach to tag releases (v*)
      - name: Upload to GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.IPA_PATH }}
