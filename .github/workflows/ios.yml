name: Firebird iOS Build (Unsigned)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    env:
      QT_VERSION: 6.6.3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      ############################################################
      # 1) Install Qt Desktop (Host Tools) - NO MODULES for Qt6
      ############################################################
      - name: Install Qt Desktop
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          modules: ""    # Important: Qt6 desktop is monolithic

      ############################################################
      # 2) Install Qt for iOS - modules are valid here
      ############################################################
      - name: Install Qt iOS
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: ios
          modules: "qtbase qtdeclarative qtmultimedia qtshadertools"

      ############################################################
      # 3) Install build tools
      ############################################################
      - name: Install CMake & Ninja
        run: |
          brew install cmake ninja

      ############################################################
      # 4) Configure CMake â†’ Xcode project for iOS
      ############################################################
      - name: Configure CMake for iOS
        run: |
          mkdir build-ios
          cd build-ios

          cmake .. \
            -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphoneos \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR;$Qt6_IOS_DIR" \
            -DQT_HOST_PATH="$Qt6_DIR"

      ############################################################
      # 5) Build via Xcode (unsigned)
      ############################################################
      - name: Build Firebird iOS app
        run: |
          cd build-ios
          xcodebuild \
            -scheme Firebird \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath derived

      ############################################################
      # 6) Package unsigned IPA
      ############################################################
      - name: Create unsigned IPA
        run: |
          cd build-ios/derived/Build/Products/Release-iphoneos
          mkdir Payload
          cp -R Firebird.app Payload/
          zip -r Firebird-unsigned.ipa Payload

      ############################################################
      # 7) Upload artifact
      ############################################################
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: firebird-ios-unsigned
          path: build-ios/derived/Build/Products/Release-iphoneos/Firebird-unsigned.ipa
