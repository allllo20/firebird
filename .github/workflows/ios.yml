name: Firebird iOS Build (Unsigned)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    env:
      QT_VERSION: 6.6.3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      ############################################################
      # Install Qt Desktop (Qt6 monolithic)
      ############################################################
      - name: Install Qt Desktop
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          modules: ""

      ############################################################
      # Install Qt for iOS (Qt6 monolithic)
      ############################################################
      - name: Install Qt for iOS
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: ios
          modules: ""

      - name: Install build tools
        run: |
          brew install cmake ninja

      ############################################################
      # Configure CMake â†’ Xcode project
      # Firebird CMakeLists.txt is inside ./firebird/
      ############################################################
      - name: Configure CMake for iOS
        run: |
          mkdir build-ios
          cd build-ios

          cmake ../firebird \
            -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphoneos \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR;$Qt6_IOS_DIR" \
            -DQT_HOST_PATH="$Qt6_DIR"

      ############################################################
      # Build Firebird (unsigned)
      ############################################################
      - name: Build Firebird iOS app
        run: |
          cd build-ios
          xcodebuild \
            -scheme Firebird \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath derived

      ############################################################
      # Package unsigned IPA
      ############################################################
      - name: Create unsigned IPA
        run: |
          cd build-ios/derived/Build/Products/Release-iphoneos
          mkdir Payload
          cp -R Firebird.app Payload/
          zip -r Firebird-unsigned.ipa Payload

      ############################################################
      # Upload artifact
      ############################################################
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: firebird-ios-unsigned
          path: build-ios/derived/Build/Products/Release-iphoneos/Firebird-unsigned.ipa
